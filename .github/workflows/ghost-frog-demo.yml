name: Ghost Frog Demo - Transparent Package Manager Interception

on:
  push:
    branches: [ main, test-failures, ghost-frog ]
  pull_request:
    branches: [ main, ghost-frog ]
  workflow_dispatch:

jobs:
  ghost-frog-npm-demo:
    name: NPM Commands via Ghost Frog
    runs-on: ubuntu-latest
    env:
      JFROG_CLI_BUILD_NAME: ghost-frog-demo
      JFROG_CLI_BUILD_NUMBER: ${{ github.run_number }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@add-package-alias
        with:
          version: 2.91.0
          download-repository: bhanu-ghost-frog
          enable-package-alias: true
          package-alias-tools: npm,mvn,go,pip,docker
        env:
          JF_URL: ${{ secrets.JFROG_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}
          JF_PROJECT: bhanu

          # Show installation status
          jf package-alias status
      
      - name: Verify NPM Interception
        run: |
          echo "ğŸ” Verifying NPM command interception..."
          echo "PATH=$PATH"
          echo ""
          
          # Show which npm will be used
          echo "Which npm: $(which npm)"
          echo "Original npm: $(which -a npm | grep -v .jfrog || echo 'Not found in PATH')"
          echo ""
          
          # This should show it's using the jf binary
          ls -la $HOME/.jfrog/package-alias/bin/npm || true
      
      - name: Create Demo NPM Project
        run: |
          echo "ğŸ“ Creating demo NPM project..."
          mkdir -p demo-project
          cd demo-project
          
          cat > package.json << EOF
          {
            "name": "ghost-frog-demo",
            "version": "1.0.0",
            "description": "Demo project for Ghost Frog transparent interception",
            "dependencies": {
              "lodash": "^4.17.21",
              "axios": "^1.6.0"
            },
            "devDependencies": {
              "jest": "^29.0.0"
            }
          }
          EOF
          
          echo "ğŸ“„ package.json created:"
          cat package.json
          
          # Configure npm to use JFrog (if configured)
          # This will fail gracefully if JFrog server isn't accessible
          echo ""
          echo "ğŸ”§ Configuring npm to use JFrog Artifactory..."
          jf npmc --repo-deploy npm-local --repo-resolve npm --server-id-deploy ghost-demo --server-id-resolve ghost-demo || echo "âš ï¸  npm configuration skipped (JFrog may not be accessible)"
      
      - name: Run NPM Commands (Transparently via JFrog CLI)
        run: |
          cd demo-project
          echo "ğŸš€ Running 'npm install' (will be intercepted by Ghost Frog)..."
          echo ""
          
          # Enable debug to see interception
          export JFROG_CLI_LOG_LEVEL=DEBUG
          
          # Show which npm will be used (should be the alias)
          echo "Using npm: $(which npm)"
          echo ""
          
          # This will actually run 'jf npm install' transparently
          # Run npm install and capture output
          echo "Note: npm install is being intercepted by Ghost Frog (running as 'jf npm install')"
          if npm install; then
            echo ""
            echo "âœ… npm install completed via Ghost Frog interception!"
            
            # Show that dependencies were installed
            if [ -d "node_modules" ]; then
              echo ""
              echo "ğŸ“¦ Installed dependencies:"
              ls -la node_modules/ | head -10
            else
              echo "âš ï¸  node_modules directory not found"
            fi
          else
            echo ""
            echo "âš ï¸  npm install failed (likely due to JFrog server not being accessible)"
            echo "   This is expected in a demo environment without proper JFrog configuration."
            echo "   The important thing is that Ghost Frog intercepted the command!"
            echo "   You can see in the logs above that 'jf npm install' was called."
            # Don't exit - continue to show other npm commands being intercepted
          fi
      
      - name: Demonstrate Other NPM Commands
        run: |
          cd demo-project
          echo "ğŸ”§ Running various NPM commands (all intercepted by Ghost Frog)..."
          echo ""
          
          # Enable debug logging to see Ghost Frog interception
          export JFROG_CLI_LOG_LEVEL=DEBUG
          
          # npm list - will be intercepted
          echo "â–¶ï¸  npm list (intercepted by Ghost Frog):"
          echo "--- Full output (including JFrog CLI debug logs) ---"
          npm list --depth=0 2>&1 || echo "   (Command failed, but Ghost Frog intercepted it)"
          echo "--- End of npm list output ---"
          
          echo ""
          
          # npm outdated - will be intercepted  
          echo "â–¶ï¸  npm outdated (intercepted by Ghost Frog):"
          echo "--- Full output (including JFrog CLI debug logs) ---"
          npm outdated 2>&1 || echo "   (Command failed, but Ghost Frog intercepted it)"
          echo "--- End of npm outdated output ---"
          
          echo ""
          echo "âœ… All NPM commands were transparently intercepted by JFrog CLI!"
          echo "   Look for JFrog CLI debug logs above showing 'Detected running as alias' or 'Running in JF mode'"
      
      - name: Show Interception Can Be Disabled
        run: |
          echo "ğŸ”Œ Demonstrating enable/disable functionality..."
          
          # Disable interception
          jf package-alias disable
          
          echo "âŒ Interception disabled - npm runs natively:"
          cd demo-project
          npm --version
          
          # Re-enable interception
          jf package-alias enable
          
          echo "âœ… Interception re-enabled"
      
      - name: Summary
        run: |
          echo "ğŸ“Š Ghost Frog Demo Summary"
          echo "========================="
          echo ""
          echo "âœ… JFrog CLI installed"
          echo "âœ… Ghost Frog aliases created"  
          echo "âœ… NPM commands transparently intercepted"
          echo "âœ… Dependencies resolved via JFrog Artifactory (when configured)"
          echo ""
          echo "ğŸ‰ With Ghost Frog, existing CI/CD pipelines work unchanged!"
          echo "   Just install JFrog CLI and run 'jf package-alias install'"
          echo ""
          echo "ğŸ“ No changes needed to:"
          echo "   - package.json"
          echo "   - npm commands"
          echo "   - build scripts"

